<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.6/lottie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>GoalTrack</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: black;
            /* Set default text color to black */
        }

        .container {
            max-width: 1200px;
            margin: auto;
            display: flex;
        }

        .task-container {
            flex: 1;
        }

        .streak-container {
            flex: 1;
            margin-left: 20px;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 8px 12px;
            margin: 5px;
            cursor: pointer;
        }

        #contribution-grid {
            display: grid;
            grid-template-columns: repeat(15, 30px);
            gap: 2px;
            margin-top: 20px;
        }

        .cell {
            width: 30px;
            height: 30px;
            border-radius: 4px;
        }

        .cell.level-0 {
            background-color: #ebedf0;
        }

        .cell.level-1 {
            background-color: #c6e48b;
        }

        .cell.level-2 {
            background-color: #7bc96f;
        }

        .cell.level-3 {
            background-color: #239a3b;
        }

        .cell.level-4 {
            background-color: #196127;
        }

        #bar-chart-container {
            width: 80%;
            /* Adjust as needed */
            height: 200px;
            /* Adjust as needed */
            margin: 20px auto;
            /* Center the chart */
        }

        .chart-container {
            padding: 20px;
            /* Add some padding around the chart */
        }
    </style>
</head>

<body>
    <nav>
        <ul>
            <li>
                <div class="home-icon">
                  <a href="/dash">
                    <img src="static/assets/business.png" alt="Home Icon" class="icon" style="height: 30px;"> <!-- Custom Home Icon --></a>
                    <div class="roof">
                        <div class="roof-edge"></div>
                    </div>
                    <div class="front"></div>
                </div>
            </li>
            <li>
                <div class="about-icon">
                  <a href="/analysis">
                    <img src="static/assets/data-analytics.png" alt="About Icon" class="icon" style="height: 30px;"> <!-- Custom About Icon --></a>
                    <div class="head">
                        <div class="eyes"></div>
                        <div class="beard"></div>
                    </div>
                </div>
            </li>
            <li>
                <div class="work-icon">
                  <a href="/LeaderBoard">
                    <img src="static/assets/podium.png" alt="Work Icon" class="icon" style="height: 30px;"> <!-- Custom Work Icon --></a>
                    <div class="paper"></div>
                    <div class="lines"></div>
                    <div class="lines"></div>
                </div>
            </li>
        </ul>
        
    </nav>
    <style>
        *,
        *:before,
        *:after {
            box-sizing: border-box;
        }

        :after {
            content: "";
        }

        section {
            position: relative;
            left: 100px;
        }

        h1 {
            margin: 80px 0 10px 0;
            font-size: 52px;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
        }

        h2 {
            font-size: 24px;
        }

        nav {
            float: left;
            position: relative;
            top: 0;
            left: 0;
            background: transparent;
        }

        nav ul {
            text-align: center;
            padding-left: 40px;
        }

        nav ul li {
            position: relative;
            width: 70px;
            cursor: pointer;
            background: linear-gradient(90deg, #083F9B, #7F56D9);
            text-transform: uppercase;
            transition: all .4s ease-out;
      
        }

        nav ul li:after {
            position: absolute;
            background: white;
            color: rgb(39, 32, 33);
            top: 0;
            left: 70px;
            width: 70px;
            height: 100%;
            opacity: .5;
            transform: perspective(400px) rotateY(90deg);
            transform-origin: 0 100%;
            transition: all .4s ease-out;
        }

        nav ul li:nth-child(1):after {
            content: " Dashboard ";
            line-height: 88px;
        }

        nav ul li:nth-child(2):after {
            content: " Analysis ";
            line-height: 88px;
        }

        nav ul li:nth-child(3):after {
            content: " LeaderBoard ";
            line-height: 85px;
        }


        nav ul li:hover {
            transform: translateX(-70px);
        }

        nav ul li:hover:after {
            opacity: 1;
            transform: perspective(400px) rotateY(0deg) scale(1);
        }


        nav ul li>div {
            display: inline-block;
            padding: 25px 0;
            background: transparent;
        }

        nav ul li div {
            position: relative;
        }
    </style>

    <div class="main-container">
        <div id="lottie-background"
            style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: -1;"></div>

        <!-- Left Section -->
        <div class="left-section">
            <!-- Container 1 : GoalTrack Logo -->
            <div class="logo-container">
                <div class="streak-container">
                    <h2>Analysis Dashboard</h2>
                    <p>Welcome to the Analysis Dashboard âœ¨! Here, you can access your weekly assessment reports to evaluate and understand your potential more effectively.</p>
                </div>
            </div>

            <!-- Container 2 : Trending and Search -->
            <div class="search-trending-container">
                <div class="trending">
                    <div class="trending-container">
                        <div id="bar-chart-container" class="chart-container">
                            <h2 class="bar-chart-title" style=" margin-top: -35px;">Assessment Scores</h2>
                            <canvas id="barChart" style="margin-top: 35px;"></canvas>
                            <p class="click-info" style="color: rgb(81, 81, 234); text-align: center; margin-top: 35px;">Click on any bar to see detailed results</p>

                        </div>
                    </div>

                    <!-- Ensure both buttons have the same size -->

                </div>

                <div class="search-section">
                    <div class='daily-note' style='min-height: 10px;'>
                        <!-- Content goes here -->
                    </div>

                </div>
            </div>



        </div>

        <!-- Container 3 : Right Image -->
        <div class="left-section">
            
            <div id="charts-container" style="width: 400px; height: 300px;">
                <div id="pie-chart-container" class="chart-container" style="width: 100%; height: 100%;">
                    <h3 class="assessment-title" id="selected-assessment-title">Assessment Details</h3>
                    <br>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            
            <div class="search-trending-container">
                <div class="trending">
                    <div class="trending-container" style="width: 100%; height: 260px";>
                    </div>

                    <!-- Ensure both buttons have the same size -->

                </div>

                <div class="search-section">
                    <div class='daily-note' style='max-height: 7px;'>
                        <!-- Content goes here -->
                    </div>

                </div>

            </div>
        </div>
    </div>

    <script>
        // Add smooth hover effect to all buttons   
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('mouseover', () => {
                button.style.transform = 'translateY(-2px)';
            });

            button.addEventListener('mouseout', () => {
                button.style.transform = 'translateY(0)';
            });
        });

        // Add focus effect to search inputs   
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('focus', () => {
                input.parentElement.style.transform = 'scale(1.01)';
            });

            input.addEventListener('blur', () => {
                input.parentElement.style.transform = 'scale(1)';
            });
        });
        var animation = lottie.loadAnimation({
            container: document.getElementById('lottie-background'), // ID of the container
            renderer: 'svg', // Render as SVG
            loop: true, // Loop the animation
            autoplay: true, // Start playing automatically
            path: '../static/json/a5.json' // Updated path to your Lottie JSON file
        });
    </script>

    <script>
        let streakData = new Array(40).fill(0); // Initialize streak data for 30 days

        async function fetchTasks() {
            const response = await fetch('/tasks');
            const tasks = await response.json();
            const buttonsDiv = document.getElementById('buttons');

            tasks.forEach(task => {
                let btn = document.createElement('button');
                btn.textContent = `Day ${task.day}`;
                btn.onclick = () => showTask(task);
                buttonsDiv.appendChild(btn);
            });
        }

        function showTask(task) {
            const container = document.getElementById('taskContainer');
            let taskHTML = `<div class="card">
                <h3>${task.head}</h3>
                <h4>${task.subhead}</h4>`;

            if (task.topics.length > 0) {
                taskHTML += `<h5>Topics:</h5>
                <p>${task.topics.join("<br>")}</p>`;
            }

            // If there are tasks, display them; otherwise, show the assessment button.
            if (task.tasks.length > 0) {
                taskHTML += `<h5>ðŸŽ¯ Tasks:</h5>
                <ul>
                    ${task.tasks.map((t, index) =>
                    `<li>
                            <input type="checkbox" id="task${task.day}_${index}" onchange="saveProgress(${task.day}, ${index})"> 
                            ${t.task}
                        </li>`
                ).join('')}
                </ul>`;
            } else {
                taskHTML += `<button onclick="takeAssessment(${task.day})">Take Assessment</button>`;
            }
            taskHTML += `</div>`;
            container.innerHTML = taskHTML;
            loadProgress(task.day);
        }

        // Modified takeAssessment to redirect to assessment4.html with the day parameter.
        function takeAssessment(day) {
            window.location.href = `assessment4.html?day=${day}`;
        }

        function saveProgress(day, index) {
            let checkbox = document.getElementById(`task${day}_${index}`);
            let progress = JSON.parse(localStorage.getItem("progress")) || {};
            if (!progress[day]) progress[day] = [];
            progress[day][index] = checkbox.checked;
            localStorage.setItem("progress", JSON.stringify(progress));

            updateStreak(day);
        }

        function loadProgress(day) {
            let progress = JSON.parse(localStorage.getItem("progress")) || {};
            if (progress[day]) {
                progress[day].forEach((checked, index) => {
                    let checkbox = document.getElementById(`task${day}_${index}`);
                    if (checkbox) checkbox.checked = checked;
                });
            }
        }

        function updateStreak(day) {
            let progress = JSON.parse(localStorage.getItem("progress")) || {};
            if (progress[day]) {
                streakData[day - 1] = progress[day].filter(checked => checked).length;
            } else {
                streakData[day - 1] = 0;
            }
            renderStreak();
        }

        function renderStreak() {
            const grid = document.getElementById("contribution-grid");
            grid.innerHTML = '';

            streakData.forEach((count, index) => {
                const cell = document.createElement("div");
                cell.classList.add("cell");

                // Determine activity level based on count.
                const level = getActivityLevel(count);
                cell.classList.add(`level-${level}`);

                grid.appendChild(cell);
            });
        }

        function getActivityLevel(count) {
            if (count === 0) return 0;
            if (count <= 1) return 1;
            if (count <= 2) return 2;
            if (count <= 3) return 3;
            return 4;
        }

        fetchTasks();
        renderStreak();
    </script>

    <script>
        // Chart.js global configuration for better aesthetics
        Chart.defaults.color = 'black'; // set default font color to black
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif'";

        // Global variables to hold chart instances
        let barChart = null;
        let pieChart = null;

        // Global variables to hold assessment data
        let assessmentData = null;

        // Color palettes for charts
        const assessmentColors = [
            '#6366f1', // primary
            '#10b981', // secondary
            '#f59e0b', // accent
            '#ec4899', // pink
            '#8b5cf6', // purple
            '#14b8a6', // teal
            '#f43f5e', // rose
            '#0ea5e9' // sky
        ];

        // Load the data when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            fetchAssessmentData();
        });

        // Fetch assessment data from the backend
        function fetchAssessmentData() {
            fetch('/api/marks')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data || !data.users || !data.scores) {
                        throw new Error("Invalid data format received from server");
                    }

                    assessmentData = data; // Store the data globally

                    // Assuming there's only one user, use the first user's data
                    const singleUser = data.users[0];
                    const scores = data.scores[singleUser];

                    // Initialize charts with the single user's data
                    initBarChart(singleUser, scores);
                    initPieChart(0, data.assessments[0]);
                })
                .catch(error => {
                    console.error('Error fetching assessment data:', error);
                    alert('Failed to load assessment data. Please try again later.');
                });
        }

        // Initialize bar chart for the single user
        function initBarChart(user, scores) {
            const ctx = document.getElementById('barChart').getContext('2d');

            if (barChart) barChart.destroy();

            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: assessmentData.assessments,
                    datasets: [{
                        label: `${user}'s Scores`,
                        data: scores,
                        backgroundColor: assessmentColors[0],
                        borderRadius: 6,
                        hoverBackgroundColor: assessmentColors[1]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10, // Assuming max score is 10
                            ticks: {
                                font: {
                                    size: 12,
                                    color: 'black' // y column name color
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12,
                                    color: 'black' // x column name color
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                color: 'black' // legend color
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(31, 41, 55, 0.9)',
                            bodyFont: {
                                size: 14,
                                color: 'black' // tooltip body color
                            },
                            titleFont: {
                                color: 'black' // tooltip title color
                            },
                            padding: 10,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    return `Score: ${context.raw} points`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            initPieChart(index, assessmentData.assessments[index]);
                        }
                    }
                }
            });
        }

        // Initialize pie chart for the first assessment
        function initPieChart(assessmentIndex, assessmentName) {
            const score = assessmentData.scores[assessmentData.users[0]][assessmentIndex];

            document.getElementById('selected-assessment-title').innerText = `${assessmentName} Detail`;

            const ctx = document.getElementById('pieChart').getContext('2d');

            if (pieChart) pieChart.destroy();

            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Correct', 'Incorrect'],
                    datasets: [{
                        data: [score, 10 - score], // Assuming max score is 10
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 5
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14,
                                    color: 'black' // legend labels color
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(31, 41, 55, 0.9)',
                            bodyFont: {
                                size: 14,
                                color: 'black' // tooltip body color
                            },
                            titleFont: {
                                color: 'black' // tooltip title color
                            },
                            padding: 10,
                            cornerRadius: 8,
                            callbacks: {
                                label: function (context) {
                                    return `${context.label}: ${context.raw} points`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }
    </script>
</body>

</html>